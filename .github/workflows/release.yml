name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger from GitHub UI

permissions:
  contents: write  # Required for creating releases

jobs:
  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
            ext: ""
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
            ext: ""
          
          # macOS builds
          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64
            ext: ""
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            ext: ""
          
          # Windows builds
          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64
            ext: .exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'  # Match your Go version
      
      - name: Get dependencies
        run: go mod download
      
      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          # Create output directory
          mkdir -p dist
          
          # Set binary name
          BINARY_NAME="mcp-filesystem-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}"
          
          # Build with version info
          VERSION="${GITHUB_REF_NAME}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GIT_COMMIT="${GITHUB_SHA:0:7}"
          
          # Static linking flags
          LDFLAGS="-s -w"
          LDFLAGS="$LDFLAGS -X 'main.Version=${VERSION}'"
          LDFLAGS="$LDFLAGS -X 'main.BuildTime=${BUILD_TIME}'"
          LDFLAGS="$LDFLAGS -X 'main.GitCommit=${GIT_COMMIT}'"
          LDFLAGS="$LDFLAGS -extldflags '-static'"
          
          echo "Building ${BINARY_NAME}"
          echo "Version: ${VERSION}"
          echo "Build Time: ${BUILD_TIME}"
          echo "Git Commit: ${GIT_COMMIT}"
          
          go build \
            -a \
            -tags netgo \
            -installsuffix netgo \
            -ldflags="${LDFLAGS}" \
            -o "dist/${BINARY_NAME}" \
            ./cmd/server
          
          # Create checksum
          cd dist
          sha256sum "${BINARY_NAME}" > "${BINARY_NAME}.sha256"
          cd ..
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-filesystem-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/mcp-filesystem-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}
            dist/mcp-filesystem-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}.sha256
          retention-days: 7

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      
      - name: Display structure of downloaded files
        run: ls -R dist
      
      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          ls -lh release/
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## mcp-filesystem Release ${{ github.ref_name }}
          
          ### Installation
          ## IMPORTANT

          This MCP Server requires a <mark>config.json</mark> file to be created in the same directory as the compiled executable.  This allows MCP servers to be shared between multiple clients rather than managing the configuration within the client itself.



          **Windows Example**

          ```json
          {
            "allowedDirectories": [
              "C:\\Users\\Username\\AppData\\Roaming\\Claude",
              "C:\\Users\\Username\\node_modules\\@modelcontextprotocol",
              "D:\\Github\\"
            ]
          }
          ```

          **Linux Example**

          ```json
          {
            "allowedDirectories": [
              "/data/github",
              "/home"
            ]
          }
          ```
          Download the appropriate binary for your platform and create the config file:
          
          **Linux (x86_64):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mcp-filesystem-linux-amd64
          chmod +x mcp-filesystem-linux-amd64
          sudo mkdir -p /usr/local/bin/mcp-servers/filesystem
          sudo mv mcp-filesystem-linux-amd64 /usr/local/bin/mcp-servers/filesystem/mcp-filesystem
          
          # Create config file with your allowed directories
          sudo tee /usr/local/bin/mcp-servers/filesystem/config.json > /dev/null <<'CONFIG'
          {
            "allowedDirectories": [
              "/home",
              "/tmp"
            ]
          }
          CONFIG
          ```
          
          **Linux (ARM64):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mcp-filesystem-linux-arm64
          chmod +x mcp-filesystem-linux-arm64
          sudo mkdir -p /usr/local/bin/mcp-servers/filesystem
          sudo mv mcp-filesystem-linux-arm64 /usr/local/bin/mcp-servers/filesystem/mcp-filesystem
          
          # Create config file with your allowed directories
          sudo tee /usr/local/bin/mcp-servers/filesystem/config.json > /dev/null <<'CONFIG'
          {
            "allowedDirectories": [
              "/home",
              "/tmp"
            ]
          }
          CONFIG
          ```
          
          **macOS (Intel):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mcp-filesystem-darwin-amd64
          chmod +x mcp-filesystem-darwin-amd64
          sudo mkdir -p /usr/local/bin/mcp-servers/filesystem
          sudo mv mcp-filesystem-darwin-amd64 /usr/local/bin/mcp-servers/filesystem/mcp-filesystem
          
          # Create config file with your allowed directories
          sudo tee /usr/local/bin/mcp-servers/filesystem/config.json > /dev/null <<'CONFIG'
          {
            "allowedDirectories": [
              "/Users/username/Documents",
              "/Users/username/Projects"
            ]
          }
          CONFIG
          ```
          
          **macOS (Apple Silicon):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/mcp-filesystem-darwin-arm64
          chmod +x mcp-filesystem-darwin-arm64
          sudo mkdir -p /usr/local/bin/mcp-servers/filesystem
          sudo mv mcp-filesystem-darwin-arm64 /usr/local/bin/mcp-servers/filesystem/mcp-filesystem
          
          # Create config file with your allowed directories
          sudo tee /usr/local/bin/mcp-servers/filesystem/config.json > /dev/null <<'CONFIG'
          {
            "allowedDirectories": [
              "/Users/username/Documents",
              "/Users/username/Projects"
            ]
          }
          CONFIG
          ```
          
          **Windows (x86_64):**
          Download `mcp-filesystem-windows-amd64.exe` and add to your PATH.
          
          ### Verification
          
          Verify your download using the SHA256 checksums:
          ```bash
          sha256sum -c mcp-filesystem-<platform>-<arch>.sha256
          ```
          
          ### Documentation
          
          - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/docs/getting-started/quick-start.md)
          - [Full Documentation](https://github.com/${{ github.repository }}/blob/main/docs/)
          
          ### What's New
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          EOF
          
          cat release_notes.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    name: Test build artifacts
    needs: build
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: mcp-filesystem-linux-amd64
            binary: mcp-filesystem-linux-amd64
          - os: macos-latest
            artifact: mcp-filesystem-darwin-arm64
            binary: mcp-filesystem-darwin-arm64
          - os: windows-latest
            artifact: mcp-filesystem-windows-amd64
            binary: mcp-filesystem-windows-amd64.exe
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: .
      
      - name: Make binary executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x ${{ matrix.binary }}
      
      - name: Test binary (Unix)
        if: runner.os != 'Windows'
        run: ./${{ matrix.binary }} --version
      
      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        run: .\${{ matrix.binary }} --version
